name: Build pfSense Package

on:
  push:
    tags:
      - 'v*'              # Production releases: v1.0.0, v2.1.3
      - 'beta-v*'         # Beta releases: beta-v1.0.0-rc1
  workflow_dispatch:      # Manual trigger from GitHub UI
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

env:
  PACKAGE_NAME: pfSense-pkg-CIDRCalculator
  PFSENSE_VERSION: "2.8"
  FREEBSD_VERSION: "14.1"  # Match pfSense 2.8 base

jobs:
  test:
    name: Run Automated Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y php-cli libxml2-utils shellcheck
        
    - name: Fix test script shebang
      run: |
        # Ensure bash shebang is used
        sed -i '1s|^#!/bin/sh|#!/bin/bash|' tests/run_tests.sh
        
    - name: Run test suite
      run: |
        chmod +x tests/run_tests.sh
        ./tests/run_tests.sh
        
    - name: Shellcheck install scripts
      run: |
        shellcheck files/pkg-install.in || true
        shellcheck files/pkg-deinstall.in || true

  validate:
    name: Validate Package Files
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check required files
      run: |
        echo "Checking for required files..."
        required_files=(
          "Makefile"
          "pkg-desc"
          "pkg-plist"
          "files/pkg-install.in"
          "files/pkg-deinstall.in"
          "files/etc/inc/priv/cidr_calc.priv.inc"
          "files/usr/local/pkg/cidr_calc.inc"
          "files/usr/local/pkg/cidr_calc.xml"
          "files/usr/local/share/pfSense-pkg-CIDRCalculator/info.xml"
          "files/usr/local/www/diag_cidr_calculator.php"
          "files/usr/local/www/widgets/widgets/cidr_calculator.widget.php"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ $file"
        done
        
    - name: Validate PHP syntax
      run: |
        echo "Validating PHP files..."
        find files -name "*.php" -o -name "*.inc" | while read file; do
          echo "Checking: $file"
          php -l "$file" || exit 1
        done
        
    - name: Validate XML syntax
      run: |
        echo "Validating XML files..."
        find files -name "*.xml" | while read file; do
          echo "Checking: $file"
          xmllint --noout "$file" || exit 1
        done
        
    - name: Check Makefile format
      run: |
        echo "Checking Makefile..."
        # Verify required variables
        grep -q "PORTNAME=" Makefile || (echo "ERROR: Missing PORTNAME" && exit 1)
        grep -q "PORTVERSION=" Makefile || (echo "ERROR: Missing PORTVERSION" && exit 1)
        grep -q ".include <bsd.port.mk>" Makefile || (echo "ERROR: Missing bsd.port.mk include" && exit 1)
        echo "✓ Makefile structure valid"
        
    - name: Check pkg-plist format
      run: |
        echo "Validating pkg-plist..."
        # Check for absolute paths (except etc/)
        if grep "^/" pkg-plist | grep -v "^etc/"; then
          echo "ERROR: Invalid absolute paths in pkg-plist"
          exit 1
        fi
        # Check for spaces (excluding @dir directives)
        if grep " " pkg-plist | grep -v "^@dir "; then
          echo "ERROR: Spaces found in pkg-plist"
          exit 1
        fi
        echo "✓ pkg-plist format valid"
        
    - name: Security scan
      run: |
        echo "Scanning for security issues..."
        
        # Check for dangerous functions
        if grep -r "eval(" files/; then
          echo "WARNING: Found eval() usage"
          exit 1
        fi
        
        if grep -r "system(" files/ --include="*.php" --include="*.inc"; then
          echo "WARNING: Found system() calls"
        fi
        
        if grep -r "shell_exec(" files/ --include="*.php" --include="*.inc"; then
          echo "WARNING: Found shell_exec() calls"
        fi
        
        # Check for potential XSS
        if grep -rn "innerHTML" files/ --include="*.php"; then
          echo "WARNING: innerHTML usage found - review for XSS"
        fi
        
        echo "✓ Security scan complete"

  build-source:
    name: Build Source Tarball
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="0.1-dev-$(git rev-parse --short HEAD)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Create source package structure
      run: |
        mkdir -p package/usr/local/pkg
        mkdir -p package/usr/local/www
        mkdir -p package/usr/local/www/widgets/widgets
        mkdir -p package/usr/local/share/pfSense-pkg-CIDRCalculator
        mkdir -p package/etc/inc/priv
        
        # Copy files to package structure
        cp -r files/* package/
        
    - name: Create source tarball
      run: |
        cd package
        tar czf ../${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz *
        cd ..
        
    - name: Generate checksums
      run: |
        sha256sum ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz > checksums-source.txt
        md5sum ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz >> checksums-source.txt
        cat checksums-source.txt
        
    - name: Upload source tarball
      uses: actions/upload-artifact@v4
      with:
        name: source-tarball-${{ steps.version.outputs.VERSION }}
        path: |
          ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz
          checksums-source.txt
        retention-days: 30

  build-freebsd-package:
    name: Build FreeBSD Package
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=$(grep "PORTVERSION=" Makefile | cut -d= -f2 | tr -d '[:space:]')
          VERSION="${VERSION}-dev-$(git rev-parse --short HEAD)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building FreeBSD package version: $VERSION"
        
    - name: Build package in FreeBSD VM
      uses: vmactions/freebsd-vm@v1
      with:
        release: ${{ env.FREEBSD_VERSION }}
        usesh: true
        prepare: |
          pkg install -y gmake
          
        run: |
          set -e
          echo "FreeBSD version:"
          freebsd-version
          
          echo "Creating staging directory..."
          mkdir -p /tmp/staging
          
          # Create directory structure
          mkdir -p /tmp/staging/usr/local/pkg
          mkdir -p /tmp/staging/usr/local/www
          mkdir -p /tmp/staging/usr/local/www/widgets/widgets
          mkdir -p /tmp/staging/usr/local/share/${{ env.PACKAGE_NAME }}
          mkdir -p /tmp/staging/etc/inc/priv
          
          # Copy files to staging
          echo "Copying files to staging..."
          cp files/usr/local/pkg/cidr_calc.xml /tmp/staging/usr/local/pkg/
          cp files/usr/local/pkg/cidr_calc.inc /tmp/staging/usr/local/pkg/
          cp files/etc/inc/priv/cidr_calc.priv.inc /tmp/staging/etc/inc/priv/
          cp files/usr/local/share/pfSense-pkg-CIDRCalculator/info.xml /tmp/staging/usr/local/share/${{ env.PACKAGE_NAME }}/
          cp files/usr/local/www/diag_cidr_calculator.php /tmp/staging/usr/local/www/
          cp files/usr/local/www/widgets/widgets/cidr_calculator.widget.php /tmp/staging/usr/local/www/widgets/widgets/
          
          # Process pkg-install and pkg-deinstall scripts
          echo "Processing install scripts..."
          sed "s/%%PORTNAME%%/${{ env.PACKAGE_NAME }}/g" files/pkg-install.in > /tmp/staging/pkg-install
          sed "s/%%PORTNAME%%/${{ env.PACKAGE_NAME }}/g" files/pkg-deinstall.in > /tmp/staging/pkg-deinstall
          chmod +x /tmp/staging/pkg-install /tmp/staging/pkg-deinstall
          
          # Extract package info from Makefile
          PORTVERSION=$(grep "PORTVERSION=" Makefile | cut -d= -f2 | tr -d '[:space:]')
          COMMENT=$(grep "COMMENT=" Makefile | cut -d= -f2- | tr -d '\t')
          MAINTAINER=$(grep "MAINTAINER=" Makefile | cut -d= -f2 | tr -d '[:space:]')
          
          # Create manifest
          echo "Creating package manifest..."
          cat > /tmp/manifest.ucl <<EOF
          name: "${{ env.PACKAGE_NAME }}"
          version: "${{ steps.version.outputs.VERSION }}"
          origin: "sysutils/${{ env.PACKAGE_NAME }}"
          comment: ${COMMENT}
          maintainer: "${MAINTAINER}"
          www: "https://github.com/IFeelFine/pfSense-pkg-CIDRCalculator"
          arch: "freebsd:14:*"
          prefix: "/usr/local"
          licenselogic: "single"
          licenses: [ "APACHE20" ]
          desc: <<EOD
          Interactive CIDR Calculator for pfSense with IPv4/IPv6 support.
          Includes a dashboard widget for quick subnet calculations.
          
          Features:
          - IPv4 and IPv6 CIDR calculations
          - Network address, broadcast address, and usable host range
          - Subnet mask conversions
          - Dashboard widget integration
          EOD
          categories: [ "sysutils" ]
          scripts: {
            post-install: "/pkg-install"
            post-deinstall: "/pkg-deinstall"
          }
          EOF
          
          echo "Package manifest:"
          cat /tmp/manifest.ucl
          
          # Create the package
          echo "Creating FreeBSD package..."
          cd /tmp/staging
          pkg create -m /tmp/manifest.ucl -r . -o /tmp -p /tmp/staging/pkg-install -d /tmp/staging/pkg-deinstall
          
          # Find the created package
          PKGFILE=$(ls /tmp/${{ env.PACKAGE_NAME }}-*.pkg 2>/dev/null || ls /tmp/${{ env.PACKAGE_NAME }}-*.txz 2>/dev/null)
          
          if [ -z "$PKGFILE" ]; then
            echo "ERROR: Package file not created"
            ls -la /tmp/
            exit 1
          fi
          
          echo "Package created: $PKGFILE"
          
          # Copy to workspace
          cp "$PKGFILE" $GITHUB_WORKSPACE/
          
          # Show package info
          echo "Package information:"
          pkg info -F "$PKGFILE"
          
          # Show package contents
          echo "Package contents:"
          pkg info -l -F "$PKGFILE"
          
    - name: Generate package checksums
      run: |
        PKGFILE=$(ls ${{ env.PACKAGE_NAME }}-*.pkg 2>/dev/null || ls ${{ env.PACKAGE_NAME }}-*.txz 2>/dev/null)
        if [ -f "$PKGFILE" ]; then
          sha256sum "$PKGFILE" > checksums-pkg.txt
          md5sum "$PKGFILE" >> checksums-pkg.txt
          cat checksums-pkg.txt
        else
          echo "ERROR: No package file found"
          ls -la
          exit 1
        fi
        
    - name: Upload FreeBSD package
      uses: actions/upload-artifact@v4
      with:
        name: freebsd-package-${{ steps.version.outputs.VERSION }}
        path: |
          ${{ env.PACKAGE_NAME }}-*.pkg
          ${{ env.PACKAGE_NAME }}-*.txz
          checksums-pkg.txt
        retention-days: 30

  release:
    name: Create Release
    needs: [build-source, build-freebsd-package]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Download source tarball
      uses: actions/download-artifact@v4
      with:
        name: source-tarball-${{ steps.version.outputs.VERSION }}
        path: ./artifacts-source/
        
    - name: Download FreeBSD package
      uses: actions/download-artifact@v4
      with:
        name: freebsd-package-${{ steps.version.outputs.VERSION }}
        path: ./artifacts-pkg/
        
    - name: Prepare release files
      run: |
        mkdir -p release-files
        cp artifacts-source/* release-files/
        cp artifacts-pkg/* release-files/
        
        # Create combined checksums
        cat artifacts-source/checksums-source.txt > release-files/checksums.txt
        cat artifacts-pkg/checksums-pkg.txt >> release-files/checksums.txt
        
        echo "Release files:"
        ls -lah release-files/
        
    - name: Extract changelog for version
      id: changelog
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        if [ -f CHANGELOG.md ]; then
          # Extract section for this version
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$ d' > release_notes.md
          if [ -s release_notes.md ]; then
            echo "Found release notes for version $VERSION"
          else
            echo "No specific release notes found, using default"
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." > release_notes.md
          fi
        else
          cat > release_notes.md <<EOF
          ## Installation
          
          ### For pfSense
          Download the \`.pkg\` or \`.txz\` file and install on your pfSense system:
          
          \`\`\`bash
          pkg add ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.pkg
          \`\`\`
          
          ### Source Installation
          Download the \`.tar.gz\` source archive for manual installation.
          
          See commit history for changes.
          EOF
        fi
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-files/${{ env.PACKAGE_NAME }}-*.tar.gz
          release-files/${{ env.PACKAGE_NAME }}-*.pkg
          release-files/${{ env.PACKAGE_NAME }}-*.txz
          release-files/checksums.txt
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
